#!/usr/bin/env node

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –ø–∞–ø–∫–∏ –≤ base64 –∏ —Å–æ–∑–¥–∞–µ—Ç TypeScript —Ñ–∞–π–ª
 *
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 * 1. –ü–æ–ª–æ–∂–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ src/assets/images/
 * 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: node scripts/images-to-base64.mjs
 * 3. –§–∞–π–ª src/assets/images-data.ts –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.resolve(__dirname, '..');
const imagesDir = path.join(projectRoot, 'src/assets/images');
const outputFile = path.join(projectRoot, 'src/assets/images-data.ts');

console.log('üñºÔ∏è  Converting images to base64...\n');

// –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if (!fs.existsSync(imagesDir)) {
  console.log(`üìÅ Creating directory: ${imagesDir}`);
  fs.mkdirSync(imagesDir, { recursive: true });
  console.log('‚úÖ Directory created');
  console.log('\n‚ö†Ô∏è  Please add images to src/assets/images/ and run this script again');
  process.exit(0);
}

// –ß–∏—Ç–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
const files = fs.readdirSync(imagesDir);
const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp'];
const imageFiles = files.filter(file => {
  const ext = path.extname(file).toLowerCase();
  return imageExtensions.includes(ext);
});

if (imageFiles.length === 0) {
  console.log('‚ö†Ô∏è  No images found in src/assets/images/');
  console.log('\nSupported formats: .jpg, .jpeg, .png, .gif, .webp, .svg, .bmp');
  console.log('\nAdd images and run this script again.');
  process.exit(0);
}

console.log(`Found ${imageFiles.length} images:\n`);

const images = {};
let totalSize = 0;

imageFiles.forEach((file, index) => {
  const filePath = path.join(imagesDir, file);
  const buffer = fs.readFileSync(filePath);
  const base64 = buffer.toString('base64');
  const ext = path.extname(file).slice(1).toLowerCase();
  const name = path.basename(file, path.extname(file));

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
  const mimeTypes = {
    'jpg': 'jpeg',
    'jpeg': 'jpeg',
    'png': 'png',
    'gif': 'gif',
    'webp': 'webp',
    'svg': 'svg+xml',
    'bmp': 'bmp'
  };

  const mimeType = mimeTypes[ext] || ext;
  images[name] = `data:image/${mimeType};base64,${base64}`;

  const sizeMB = (buffer.length / 1024 / 1024).toFixed(2);
  totalSize += buffer.length;

  console.log(`  ${index + 1}. ${file.padEnd(40)} ‚Üí ${name.padEnd(20)} (${sizeMB} MB)`);
});

console.log(`\nüìä Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB\n`);

// –°–æ–∑–¥–∞–µ–º TypeScript —Ñ–∞–π–ª
const output = `/**
 * Auto-generated file
 * DO NOT EDIT MANUALLY
 *
 * Generated by: scripts/images-to-base64.mjs
 * Generated at: ${new Date().toISOString()}
 * Total images: ${imageFiles.length}
 * Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB
 */

export const images: Record<string, string> = ${JSON.stringify(images, null, 2)};

// Type-safe access
export type ImageName = keyof typeof images;

// Helper to get image by name
export function getImage(name: ImageName): string {
  return images[name];
}

// List all available images
export function listImages(): ImageName[] {
  return Object.keys(images) as ImageName[];
}
`;

fs.writeFileSync(outputFile, output);

console.log('‚úÖ Generated: src/assets/images-data.ts\n');
console.log('Usage example:');
console.log('');
console.log('  import { images } from \'../assets/images-data\';');
console.log('');
console.log('  export const productsData = [');
console.log('    {');
console.log('      title: \'iPhone 15 Pro\',');
console.log('      image: images.iphone,  // ‚Üê Use base64 image');
console.log('      price: \'89 990 ‚ÇΩ\'');
console.log('    }');
console.log('  ];');
console.log('');

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∞–∑–º–µ—Ä–µ
if (totalSize > 5 * 1024 * 1024) {
  console.log('‚ö†Ô∏è  WARNING: Total image size is > 5 MB');
  console.log('   This may increase plugin load time.');
  console.log('   Consider optimizing images or using fewer images.\n');
}

console.log('‚ú® Done!\n');

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="ui.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SnapFill</h1>
      <p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞</p>
    </div>

    <div class="content">
      <div class="section">
        <label class="label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ JSON —Ñ–∞–π–ª</label>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" accept=".csv,.json" class="file-input">
          <label for="fileInput" class="file-label">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
          <span id="fileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        </div>
      </div>

      <div class="section" id="previewSection" style="display: none;">
        <label class="label">
          <span>–ü—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö:</span>
          <span id="dataCount" class="data-count"></span>
        </label>
        <div id="dataPreview" class="data-preview"></div>
      </div>

      <div class="section">
        <label class="label info">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 1a6 6 0 110 12A6 6 0 018 2zm0 2a1 1 0 100 2 1 1 0 000-2zm-1 3a1 1 0 011-1h0a1 1 0 011 1v3a1 1 0 01-1 1h0a1 1 0 01-1-1V7z"/>
          </svg>
          <span>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ª–æ–∏ –≤ —Ñ—Ä–µ–π–º–µ –Ω–∞–∑–≤–∞–Ω—ã –∫–∞–∫ –ø–æ–ª—è –≤ —Ñ–∞–π–ª–µ –¥–∞–Ω–Ω—ã—Ö</span>
        </label>
      </div>

      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="successMessage" class="success-message" style="display: none;"></div>
    </div>

    <div class="footer">
      <button id="randomButton" class="button button-random" disabled>üé≤ –°–ª—É—á–∞–π–Ω—ã–π</button>
      <button id="fillButton" class="button button-primary" disabled>–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
      <button id="cancelButton" class="button button-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const fillButton = document.getElementById('fillButton');
    const randomButton = document.getElementById('randomButton');
    const cancelButton = document.getElementById('cancelButton');
    const previewSection = document.getElementById('previewSection');
    const dataPreview = document.getElementById('dataPreview');
    const dataCount = document.getElementById('dataCount');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    let allData = null; // Store all data (array or single object)
    let currentData = null; // Current data to fill
    let isArray = false;

    // File input handler
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      fileName.textContent = file.name;
      hideMessages();

      try {
        const text = await file.text();
        
        if (file.name.endsWith('.json')) {
          const parsed = JSON.parse(text);
          // Check if it's an array
          if (Array.isArray(parsed)) {
            allData = parsed;
            currentData = parsed[0];
            isArray = true;
          } else {
            allData = parsed;
            currentData = parsed;
            isArray = false;
          }
        } else if (file.name.endsWith('.csv')) {
          allData = parseCSVAll(text);
          currentData = allData[0];
          isArray = true;
        }

        displayPreview(currentData);
        fillButton.disabled = false;
        randomButton.disabled = !isArray; // Enable random button only for arrays
      } catch (error) {
        showError(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${error.message}`);
        fillButton.disabled = true;
        randomButton.disabled = true;
      }
    });

    // Fill button handler
    fillButton.addEventListener('click', () => {
      if (currentData) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'fill-data', 
            data: currentData 
          } 
        }, '*');
      }
    });

    // Random button handler
    randomButton.addEventListener('click', () => {
      if (isArray && allData && allData.length > 0) {
        const randomIndex = Math.floor(Math.random() * allData.length);
        currentData = allData[randomIndex];
        displayPreview(currentData);
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'fill-data', 
            data: currentData 
          } 
        }, '*');
      }
    });

    // Cancel button handler
    cancelButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });

    // Parse CSV - returns array of all rows
    function parseCSVAll(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) {
        throw new Error('CSV —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö');
      }

      const headers = lines[0].split(',').map(h => h.trim());
      const results = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        results.push(row);
      }

      return results;
    }

    // Display data preview
    function displayPreview(data) {
      previewSection.style.display = 'block';
      dataPreview.innerHTML = '';

      // Show data count if it's an array
      if (isArray && allData) {
        dataCount.textContent = `(${allData.length} –∑–∞–ø–∏—Å–µ–π)`;
        dataCount.style.display = 'inline';
      } else {
        dataCount.style.display = 'none';
      }

      const fields = Object.keys(data).slice(0, 5); // Show first 5 fields
      fields.forEach(key => {
        const field = document.createElement('div');
        field.className = 'preview-field';
        field.innerHTML = `<strong>${key}:</strong> ${truncate(data[key], 30)}`;
        dataPreview.appendChild(field);
      });

      if (Object.keys(data).length > 5) {
        const more = document.createElement('div');
        more.className = 'preview-field';
        more.textContent = `...–∏ –µ—â–µ ${Object.keys(data).length - 5} –ø–æ–ª–µ–π`;
        dataPreview.appendChild(more);
      }
    }

    // Truncate text
    function truncate(text, length) {
      const str = String(text);
      return str.length > length ? str.substring(0, length) + '...' : str;
    }

    // Message handlers
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'error') {
        showError(msg.message);
      } else if (msg.type === 'success') {
        showSuccess(msg.message);
      }
    };

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }
  </script>
</body>
</html>

